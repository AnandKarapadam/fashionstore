<%- include("../partials/admin/header.ejs") %>

<%- include("../partials/admin/sidebar.ejs") %>

<div class="container">
  <div class="row mt-5 jusitfy-content-center">
    <div class="col-md-4">
      <a href="/admin/users" class="text-decoration-none text-dark">
      <div class="card text-center p-2 shadow-sm bg-light">
        <h2 style="text-shadow: 2px 1px 2px #000000;" class="fw-semibold">Active Users</h2>
        <i class="bi bi-list-ol fs-1 text-success fw-bold"></i>
        <p class="fw-bold fs-3">Count : <span class="text-primary fw-bold" style="text-shadow: 2px 1px 2px #000000;"  ><%= count%></span> </p>
      </div>
      </a>
    </div>
    
    <div class="col-md-4">
      <a href="/admin/products" class="text-decoration-none text-dark">
      <div class="card text-center p-2  shadow-sm bg-light">
        <h2 style="text-shadow: 2px 1px 2px #000000;" class="fw-semibold">Active Products</h2>
        <i class="bi bi-luggage-fill fs-1 text-primary fw-bold"></i>
        <p class="fw-bold fs-3">Count : <span class="text-success fw-bold" style="text-shadow: 2px 1px 2px #000000;"><%= products%></span> </p>
      </div>
    </a>
    </div>

    <div class="col-md-4">
      <a href="/admin/brands" class="text-decoration-none text-dark">
       <div class=" card text-center p-2  shadow-sm bg-light">
        <h2 style="text-shadow: 2px 1px 2px #000000;" class="fw-semibold">Companies</h2>
        <i class="bi bi-suitcase-lg-fill text-danger fw-bold fs-1"></i>
        <p class="fw-bold fs-3">Count : <span class="text-warning fw-bold" style="text-shadow: 2px 1px 2px #000000;"><%= brand%></span> </p>
      </div>
      </a>
  </div>
  </div>
</div>
<div class="d-flex w-100 mt-4">
  <hr class="w-75 mx-auto border border-2 border-dark">
</div>
<div class="container mt-4">
  <h3 class="mb-4 text-center mb-5">ðŸ“Š Sales Report</h3>

  <!-- Filter Form -->
  <form class="row g-3 align-items-end" method="get" action="/admin">
    <div class="col-md-3">
      <label class="form-label">Filter By</label>
      <select class="form-select" name="filter" id="filterSelect" onchange="toggleCustomDate()" required>
        <option value="daily" <%= filter==='daily' ? 'selected' : '' %>>Daily</option>
        <option value="weekly" <%= filter==='weekly' ? 'selected' : '' %>>Weekly</option>
        <option value="monthly" <%= filter==='monthly' ? 'selected' : '' %>>Monthly</option>
        <option value="yearly" <%= filter==='yearly' ? 'selected' : '' %>>Yearly</option>
        <option value="custom" <%= filter==='custom' ? 'selected' : '' %>>Custom</option>
      </select>
    </div>

    <!-- Custom date range (only visible if filter=custom) -->
    <div class="col-md-3 custom-date d-none">
      <label class="form-label">Start Date</label>
      <input type="date" class="form-control" name="startDate" value="<%= startDate || '' %>">
    </div>
    <div class="col-md-3 custom-date d-none">
      <label class="form-label">End Date</label>
      <input type="date" class="form-control" name="endDate" value="<%= endDate || '' %>">
    </div>

    <div class="col-md-1">
      <button type="submit" class="btn btn-primary w-100">Apply</button>
    </div>
    <div class="col-md-1">
      <a href="/admin" class="btn btn-outline-dark">Clear</a>
    </div>
  </form>

  <!-- Summary Section -->
  <div class="row mt-4">
    <div class="col-md-4">
      <div class="card shadow-sm p-3 text-center">
        <h5>Total Orders</h5>
        <p class="fs-4 fw-bold"><%= totalOrders %></p>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm p-3 text-center">
        <h5>Total Sales</h5>
        <p class="fs-4 fw-bold text-success">â‚¹<%= totalSales %></p>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm p-3 text-center">
        <h5>Total Products Sold</h5>
        <p class="fs-4 fw-bold text-danger"><%= totalProductsSold %></p>
      </div>
    </div>
  </div>

  <!-- Orders Table -->
  <div class="table-responsive mt-4">
    <table class="table table-bordered table-hover">
      <thead class="table-light">
        <tr>
          <th>Order ID</th>
          <th>User</th>
          <th>Date</th>
          <th>Amount</th>
          <th>Payment</th>
          <th>Coupon</th>
        </tr>
      </thead>
      <tbody>
        <% if (orders.length > 0) { %>
          <% orders.forEach(order => { %>
            <tr>
              <td><%= order.orderId %></td>
              <td><%= order.userId ? order.userId.name : "Guest" %></td>
              <td><%= order.createOn.toDateString() %></td>
              <td>â‚¹<%= order.totalPrice %></td>
              <td><%= order.paymentMethod %></td>
              <td>â‚¹<%= order.discount || 0 %></td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="6" class="text-center text-muted">No orders found for this filter.</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>
  <div class="container mt-3" id="paginationSection">
            <nav aria-label="Page navigation">
                <ul class="pagination pagination-sm justify-content-center mb-4" style="margin-right: -50px;">
                  <% const maxVisiblePages=3; let startPage=Math.max(1, currentPage - 1); let endPage=startPage +
                        maxVisiblePages - 1; if (endPage> totalPages) {
                        endPage = totalPages;
                        startPage = Math.max(1, endPage - maxVisiblePages + 1);
                        }
                        %>

                        <!-- Previous Button -->
                        <li class="page-item  <%= currentPage == 1 ? 'disabled' : '' %>">
                            <a class="page-link" href="?page=<%= parseInt(currentPage) - 1 %>">&laquo;</a>
                        </li>

                        <!-- Page Numbers -->
                        <% for (let i=startPage; i <=endPage; i++) { %>
                            <li class="page-item <%= i == currentPage ? 'active' : '' %>">
                                <a class="page-link" href="?page=<%= i %>">
                                    <%= i %>
                                </a>
                            </li>
                            <% } %>

                                <!-- Next Button -->
                                <li class="page-item <%= currentPage == totalPages ? 'disabled' : '' %>">
                                    <a class="page-link"
                                        href="?page=<%= parseInt(currentPage) + 1 %>">&raquo;</a>
                                </li>
                </ul>
            </nav>
        </div>
  
  <!-- Download Buttons -->
  <div class="mt-3 d-flex gap-2">
    <a href="/admin/sales-report/download?type=pdf&<%= `filter=${filter}&startDate=${startDate||''}&endDate=${endDate||''}` %>" 
       class="btn btn-danger">Download PDF</a>
    <a href="/admin/sales-report/download?type=excel&<%= `filter=${filter}&startDate=${startDate||''}&endDate=${endDate||''}` %>" 
       class="btn btn-success">Download Excel</a>
  </div>
</div>
<script>
  function toggleCustomDate() {
    const filter = document.getElementById("filterSelect").value;
    const customFields = document.querySelectorAll(".custom-date");
    if (filter === "custom") {
      customFields.forEach(el => el.classList.remove("d-none"));
    } else {
      customFields.forEach(el => el.classList.add("d-none"));
    }
  }
  // Call once on page load
  toggleCustomDate();
</script>

<%- include("../partials/admin/footer.ejs") %>