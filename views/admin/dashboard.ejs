<%- include("../partials/admin/header.ejs") %>

<%- include("../partials/admin/sidebar.ejs") %>

<div class="container mt-5">
  
  <form action="/admin" method="get" class="mb-3">
    <select name="chartFilter" onchange="this.form.submit()" class="form-select w-auto d-inline-block" >
      <option value="">All Time</option>
      <option value="topDaily" <%= chartFilter==="topDaily"?"selected":"" %>>Daily</option>
      <option value="topMonthly" <%= chartFilter==="topMonthly"?"selected":"" %>>Monthly</option>
      <option value="topYearly" <%= chartFilter==="topYearly"?"selected":"" %>>Yearly</option>
    </select>
  </form>

  <div class="row">
    <div class="col-md-4">
      <canvas id="topProductsChart" style="width: 420px;height: 300px;"></canvas>
    </div>
    <div class="col-md-4">
      <canvas id="topCategoriesChart" style="width: 420px;height: 300px;" ></canvas>
    </div>
    <div class="col-md-4">
      <canvas id="topBrandsChart" style="width: 420px;height: 300px;" ></canvas>
    </div>
  </div>

</div>
<div class="d-flex w-100 mt-4">
  <hr class="w-75 mx-auto border border-2 border-dark">
</div>
<div id="salesreport" class="container mt-4">
  <h3 class="mb-4 text-center mb-5">ðŸ“Š Sales Report</h3>

  <!-- Filter Form -->
  <form class="row g-3 align-items-end" method="get" action="/admin">
    <div class="col-md-3">
      <label class="form-label">Filter By</label>
      <select class="form-select" name="filter" id="filterSelect" onchange="toggleCustomDate()" required>
        <option value="daily" <%= filter==='daily' ? 'selected' : '' %>>Daily</option>
        <option value="weekly" <%= filter==='weekly' ? 'selected' : '' %>>Weekly</option>
        <option value="monthly" <%= filter==='monthly' ? 'selected' : '' %>>Monthly</option>
        <option value="yearly" <%= filter==='yearly' ? 'selected' : '' %>>Yearly</option>
        <option value="custom" <%= filter==='custom' ? 'selected' : '' %>>Custom</option>
      </select>
    </div>

    <!-- Custom date range (only visible if filter=custom) -->
    <div class="col-md-3 custom-date d-none">
      <label class="form-label">Start Date</label>
      <input type="date" class="form-control" name="startDate" value="<%= startDate || '' %>">
    </div>
    <div class="col-md-3 custom-date d-none">
      <label class="form-label">End Date</label>
      <input type="date" class="form-control" name="endDate" value="<%= endDate || '' %>">
    </div>

    <div class="col-md-1">
      <button type="submit" class="btn btn-primary w-100">Apply</button>
    </div>
    <div class="col-md-1">
      <a href="/admin/#salesreport" class="btn btn-outline-dark">Clear</a>
    </div>
  </form>

  <!-- Summary Section -->
  <div class="row mt-4">
    <div class="col-md-4">
      <div class="card shadow-sm p-3 text-center">
        <h5>Total Orders</h5>
        <p class="fs-4 fw-bold"><%= totalOrders %></p>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm p-3 text-center">
        <h5>Total Sales</h5>
        <p class="fs-4 fw-bold text-success">â‚¹<%= totalSales %></p>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm p-3 text-center">
        <h5>Total Products Sold</h5>
        <p class="fs-4 fw-bold text-danger"><%= totalProductsSold %></p>
      </div>
    </div>
  </div>

  <!-- Orders Table -->
  <div class="table-responsive mt-4">
    <table class="table table-bordered table-hover">
      <thead class="table-light">
        <tr>
          <th>Order ID</th>
          <th>User</th>
          <th>Date</th>
          <th>Amount</th>
          <th>Payment</th>
          <th>Coupon</th>
        </tr>
      </thead>
      <tbody>
        <% if (orders.length > 0) { %>
          <% orders.forEach(order => { %>
            <tr>
              <td><%= order.orderId %></td>
              <td><%= order.userId ? order.userId.name : "Guest" %></td>
              <td><%= order.createOn.toDateString() %></td>
              <td>â‚¹<%= order.totalPrice %></td>
              <td><%= order.paymentMethod %></td>
              <td>â‚¹<%= order.discount || 0 %></td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="6" class="text-center text-muted">No orders found for this filter.</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>
  <div class="container mt-3" id="paginationSection">
            <nav aria-label="Page navigation">
                <ul class="pagination pagination-sm justify-content-center mb-4" style="margin-right: -50px;">
                  <% const maxVisiblePages=3; let startPage=Math.max(1, currentPage - 1); let endPage=startPage +
                        maxVisiblePages - 1; if (endPage> totalPages) {
                        endPage = totalPages;
                        startPage = Math.max(1, endPage - maxVisiblePages + 1);
                        }
                        %>

                        <!-- Previous Button -->
                        <li class="page-item  <%= currentPage == 1 ? 'disabled' : '' %>">
                            <a class="page-link" href="?page=<%= parseInt(currentPage) - 1 %>">&laquo;</a>
                        </li>

                        <!-- Page Numbers -->
                        <% for (let i=startPage; i <=endPage; i++) { %>
                            <li class="page-item <%= i == currentPage ? 'active' : '' %>">
                                <a class="page-link" href="?page=<%= i %>">
                                    <%= i %>
                                </a>
                            </li>
                            <% } %>

                                <!-- Next Button -->
                                <li class="page-item <%= currentPage == totalPages ? 'disabled' : '' %>">
                                    <a class="page-link"
                                        href="?page=<%= parseInt(currentPage) + 1 %>">&raquo;</a>
                                </li>
                </ul>
            </nav>
        </div>
  
  <!-- Download Buttons -->
  <div class="mt-3 d-flex gap-2">
    <a href="/admin/sales-report/download?type=pdf&<%= `filter=${filter}&startDate=${startDate||''}&endDate=${endDate||''}` %>" 
       class="btn btn-danger">Download PDF</a>
    <a href="/admin/sales-report/download?type=excel&<%= `filter=${filter}&startDate=${startDate||''}&endDate=${endDate||''}` %>" 
       class="btn btn-success">Download Excel</a>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>


const topProducts = JSON.parse('<%- JSON.stringify(topProducts || []) %>');
const topCategories= JSON.parse('<%- JSON.stringify(topCategories || []) %>');
const topBrands = JSON.parse('<%- JSON.stringify(topBrands || []) %>');


function createBarChart(ctxId,dataArr,labelText){
  const ctx = document.getElementById(ctxId).getContext("2d");

  const palettes = {
    "Top Products": [
      "rgba(54, 162, 235, 0.6)",   // blue
      "rgba(100, 181, 246, 0.6)",  // light blue
      "rgba(25, 118, 210, 0.6)",   // dark blue
      "rgba(3, 169, 244, 0.6)",    // cyan
      "rgba(0, 188, 212, 0.6)"     
    ],
    "Top Categories": [
      "rgba(255, 99, 132, 0.6)",   // red
      "rgba(255, 138, 101, 0.6)",  // coral
      "rgba(229, 57, 53, 0.6)",    // dark red
      "rgba(244, 81, 30, 0.6)",    // orange-red
      "rgba(211, 47, 47, 0.6)"     // crimson
    ],
    "Top Brands": [
      "rgba(76, 175, 80, 0.6)",    // green
      "rgba(139, 195, 74, 0.6)",   // lime
      "rgba(56, 142, 60, 0.6)",    // forest green
      "rgba(102, 187, 106, 0.6)",  // light green
      "rgba(67, 160, 71, 0.6)"     // medium green
    ]
  };

 
  const palette = palettes[labelText] || [
    "rgba(54, 162, 235, 0.6)",
    "rgba(75, 192, 192, 0.6)",
    "rgba(153, 102, 255, 0.6)"
  ];

const borderColor = palette.map(c=>c.replace("0.6","1"));

  return new Chart(ctx,{
    type:"bar",
    data:{
      labels:dataArr.map(item=>item.name),
      datasets:[{
        label:labelText,
        data:dataArr.map(item=>item.totalSold),
        backgroundColor: dataArr.map((_,i)=>palette[i%palette.length]),
        borderColor: dataArr.map((_,i)=>borderColor[i%borderColor.length]),
        borderWidth:1
      }]
    },
    options:{
      responsive:true,
      animation:true,
      maintainAspectRatio: false,
      plugins:{
        legend:{display:true},
        tooltip:{enabled:true,animation:true},
        title:{
          display:true,
          text:labelText,
          font:{size:18,weight:"bold"},
          padding:{top:5,bottom:10}
        }
      },
      scales:{
        x: {
      ticks: {
        autoSkip: true,
        maxTicksLimit:10,
        maxRotation: 0, // keep labels straight
        minRotation: 0 , // prevent tilt
        callback: function(value, index, ticks) {
          let label = this.getLabelForValue(value);
          return label.length > 10 ? label.substring(0, 10) + "â€¦" : label;
        }
      }
    },
        y:{
          beginAtZero:true,
          ticks:{precision:0,autoSkip:true,maxTicksLimit:6,callback:function(value){return value}}
        }
      }
    }
  })


}

if(topProducts.length) createBarChart("topProductsChart",topProducts,"Top Products");
if(topCategories.length) createBarChart("topCategoriesChart",topCategories,"Top Categories");
if(topBrands.length) createBarChart("topBrandsChart",topBrands,"Top Brands")

function toggleCustomDate() {
    const filter = document.getElementById("filterSelect").value;
    const customFields = document.querySelectorAll(".custom-date");
    if (filter === "custom") {
      customFields.forEach(el => el.classList.remove("d-none"));
    } else {
      customFields.forEach(el => el.classList.add("d-none"));
    }
  }
  // Call once on page load
  toggleCustomDate();
</script>

<%- include("../partials/admin/footer.ejs") %>