<%- include("../partials/admin/header.ejs") %>
<%- include("../partials/admin/sidebar.ejs") %>



<div class="container mt-5 pt-4">
  <h2 class="mb-4 fw-bold">Order Management</h2>

  <!-- ðŸ” Search, Filter, Sort Controls -->
  <form class="row g-3 mb-3" method="GET" action="/admin/orders">
    <div class="col-md-3">
      <input type="text" class="form-control" name="search" placeholder="Search by Order ID or User" value="<%= search || '' %>">
    </div>
    <div class="col-md-3">
      <select name="status" class="form-select">
        <option value="">Filter by Status</option>
        <option value="Pending">Pending</option>
        <option value="Shipped">Shipped</option>
        <option value="Out for Delivery">Out for Delivery</option>
        <option value="Delivered">Delivered</option>
        <option value="Cancelled">Cancelled</option>
      </select>
    </div>
    <div class="col-md-3">
      <select name="sort" class="form-select">
        <option value="">Sort by</option>
        <option value="newest">Date: Newest</option>
        <option value="oldest">Date: Oldest</option>
        <option value="amountHigh">Amount: High to Low</option>
        <option value="amountLow">Amount: Low to High</option>
      </select>
    </div>
    <div class="col-md-3 d-flex gap-2">
      <button class="btn btn-dark" type="submit">Apply</button>
      <a href="/admin/orders" class="btn btn-outline-secondary">Clear</a>
    </div>
  </form>

  <!-- ðŸ“‹ Orders Table -->
  <div class="table-responsive">
    <table class="table table-bordered align-middle text-center">
      <thead class="table-dark">
        <tr>
          <th>Order ID</th>
          <th>User</th>
          <th>Date</th>
          <th>Total</th>
          <th>Status</th>
          <th>Return Request</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% orders.forEach(order => { %>
          <tr>
            <td><%= order._id %></td>
            <td><%= order.userId.name %><br><small><%= order.userId.email %></small></td>
            <td><%= order.createdAt.toLocaleDateString() %></td>
            <td>â‚¹<%= order.totalAmount %></td>
            <td>
              <form method="POST" action="/admin/orders/update-status" class="d-flex justify-content-center align-items-center gap-2">
                <input type="hidden" name="orderId" value="<%= order._id %>">
                <select name="status" class="form-select form-select-sm">
                  <option selected disabled><%= order.status %></option>
                  <option value="Pending">Pending</option>
                  <option value="Shipped">Shipped</option>
                  <option value="Out for Delivery">Out for Delivery</option>
                  <option value="Delivered">Delivered</option>
                  <option value="Cancelled">Cancelled</option>
                </select>
                <button class="btn btn-sm btn-primary">Update</button>
              </form>
            </td>
            <td>
              <% if (order.returnRequest === 'requested') { %>
                <form method="POST" action="/admin/orders/return-verify" class="d-flex gap-2">
                  <input type="hidden" name="orderId" value="<%= order._id %>">
                  <button class="btn btn-sm btn-success">Accept</button>
                  <button class="btn btn-sm btn-danger">Reject</button>
                </form>
              <% } else { %>
                <span class="badge bg-secondary">None</span>
              <% } %>
            </td>
            <td>
              <a href="/admin/orders/<%= order._id %>" class="btn btn-sm btn-outline-dark">
                View
              </a>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <!-- ðŸ“„ Pagination -->
  <div class="container mt-3" id="paginationSection">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mb-4" style="margin-right: -50px;">
                  <% const maxVisiblePages=3; let startPage=Math.max(1, currentPage - 1); let endPage=startPage +
                        maxVisiblePages - 1; if (endPage> totalPages) {
                        endPage = totalPages;
                        startPage = Math.max(1, endPage - maxVisiblePages + 1);
                        }
                        %>

                        <!-- Previous Button -->
                        <li class="page-item <%= currentPage == 1 ? 'disabled' : '' %>">
                            <a class="page-link" href="?page=<%= parseInt(currentPage) - 1 %>&search=<%= search %>">&laquo;</a>
                        </li>

                        <!-- Page Numbers -->
                        <% for (let i=startPage; i <=endPage; i++) { %>
                            <li class="page-item <%= i == currentPage ? 'active' : '' %>">
                                <a class="page-link" href="?page=<%= i %>&search=<%= search %>">
                                    <%= i %>
                                </a>
                            </li>
                            <% } %>

                                <!-- Next Button -->
                                <li class="page-item <%= currentPage == totalPages ? 'disabled' : '' %>">
                                    <a class="page-link"
                                        href="?page=<%= parseInt(currentPage) + 1 %>&search=<%= search %>">&raquo;</a>
                                </li>
                </ul>
            </nav>
        </div>
</div>





<%- include("../partials/admin/footer.ejs") %>
