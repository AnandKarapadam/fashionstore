<%- include("../partials/admin/header.ejs") %>
<%- include("../partials/admin/sidebar.ejs") %>



<div class="container mt-5 pt-4">
  <h2 class="mb-4 fw-bold">Order Management</h2>

  <!-- ðŸ” Search, Filter, Sort Controls -->
  <form class="row g-3 mb-3" method="GET" action="/admin/orders/order-details/<%=order.orderId %>">
    <div class="col-md-3">
      <input type="text" class="form-control" name="search" placeholder="Search by Item ID" value="<%= search || '' %>">
    </div>
    <div class="col-md-3">
      <select name="status" class="form-select" onchange="this.form.submit()">
        <option value="">Filter by Status</option>
        <option value="Pending" <%= status === 'Pending'?'selected':'' %>>Pending</option>
        <option value="Shipped" <%= status === 'Shipped'?'selected':'' %>>Shipped</option>
        <option value="Out for Delivery" <%= status === 'Out for Delivery'?'selected':'' %>>Out for Delivery</option>
        <option value="Delivered" <%= status === 'Delivered'?'selected':'' %>>Delivered</option>
        <option value="Cancelled" <%= status === 'Cancelled'?'selected':'' %>>Cancelled</option>
        <option value="Processing" <%= status === 'Processing'?'selected':'' %>>Processing</option>
        <option value="Return Request" <%= status === 'Return Request'?'selected':'' %>>Return Request</option>
      </select>
    </div>
    <div class="col-md-3">
      <select name="sort" class="form-select" onchange="this.form.submit()">
        <option value="" >Sort by</option>
        <option value="newest" <%= sort==="newest"?'selected':'' %> >Date: Newest</option>
        <option value="oldest" <%= sort==="oldest"?'selected':'' %>>Date: Oldest</option>
        <option value="amountHigh" <%= sort==="amountHigh"?'selected':'' %>>Amount: High to Low</option>
        <option value="amountLow" <%= sort==="amountLow"?'selected':'' %>>Amount: Low to High</option>
      </select>
    </div>
    <div class="col-md-3 d-flex gap-2">
      <button class="btn btn-dark" type="submit">Apply</button>
      <a href="/admin/orders/order-details/<%= order.orderId %>" class="btn btn-outline-secondary">Clear</a>
    </div>
  </form>

  <!-- ðŸ“‹ Orders Table -->
  <div class="table-responsive">
    <table class="table table-bordered align-middle text-center">
      <thead class="table-dark">
        <tr>
          <th>Item ID</th>
          <th>Product</th>
          <th>Date</th>
          <th>Time</th>
          <th>Quantity</th>
          <th>Total</th>
          <th>Status</th>
          <th>Return Request</th>
          <th>Return reason</th>
        </tr>
      </thead>
      <tbody>
        <% products.forEach(product => { %>
          <tr>
            <td><%= product.orderItemId %></td>
            <td><%= product.productName %></td>
            <td><%= product.orderDate.toLocaleDateString() %></td>
            <th><%= product.orderDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %></th>
            <th><%= product.quantity %></th>
            <td class="text-success fw-bold">â‚¹<%= order.totalPrice %></td>
            <td>
              <form method="POST" action="/admin/orders/order-details/<%= order.orderId %>/update-status" class="update-status-form d-flex justify-content-center align-items-center gap-2" data-item-id="<%= product.orderItemId %>">
                <input type="hidden" name="order_id" value="<%= product.productId %>">
                <select name="status" class="form-select form-select-sm">
                  <option selected disabled><%= product.status %></option>
                  <option value="Pending" <%= product.status ==="Pending"?'selected':''%>>Pending</option>
                  <option value="Shipped" <%= product.status ==="Shipped"?'selected':''%>>Shipped</option>
                  <option value="Out for Delivery" <%= product.status ==="Out for Delivery"?'selected':''%>>Out for Delivery</option>
                  <option value="Delivered" <%= product.status ==="Delivered"?'selected':''%>>Delivered</option>
                  <option value="Cancelled" <%= product.status ==="Cancelled"?'selected':''%>>Cancelled</option>
                  <option value="Pending" <%= product.status ==="Returned"?'selected':''%>>Returned</option>
                </select>
                <button class="btn btn-sm btn-primary">Update</button>
              </form>
            </td> 
            <td>
              <% if (product.status==="Return Request"){ %>
              <span class="badge bg-danger">Requested</span>
              <% }else {%>
                <span class="badge bg-secondary">No Request</span>
                <% } %>
            </td>
            <td>
              <% if (product.status === 'Return Request') { %>
                <span><small><%= product.returnReason %></small></span>
              <% } else { %>
                <span class="badge bg-secondary">None</span>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <!-- ðŸ“„ Pagination -->
  <div class="container mt-3" id="paginationSection">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mb-4" style="margin-right: -50px;">
                  <% const maxVisiblePages=3; let startPage=Math.max(1, currentPage - 1); let endPage=startPage +
                        maxVisiblePages - 1; if (endPage> totalPages) {
                        endPage = totalPages;
                        startPage = Math.max(1, endPage - maxVisiblePages + 1);
                        }
                        %>

                        <!-- Previous Button -->
                        <li class="page-item <%= currentPage == 1 ? 'disabled' : '' %>">
                            <a class="page-link" href="?page=<%= parseInt(currentPage) - 1 %>&search=<%= search %>">&laquo;</a>
                        </li>

                        <!-- Page Numbers -->
                        <% for (let i=startPage; i <=endPage; i++) { %>
                            <li class="page-item <%= i == currentPage ? 'active' : '' %>">
                                <a class="page-link" href="?page=<%= i %>&search=<%= search %>">
                                    <%= i %>
                                </a>
                            </li>
                            <% } %>

                                <!-- Next Button -->
                                <li class="page-item <%= currentPage == totalPages ? 'disabled' : '' %>">
                                    <a class="page-link"
                                        href="?page=<%= parseInt(currentPage) + 1 %>&search=<%= search %>">&raquo;</a>
                                </li>
                </ul>
            </nav>
        </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script src="/script/admin/orderdetails.js"></script>



<%- include("../partials/admin/footer.ejs") %>
