<%- include("../partials/admin/header.ejs") %>
<%- include("../partials/admin/sidebar.ejs") %>

<div class="card shadow-lg border-0" style="max-width: 700px; margin: 50px auto; border-radius: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1)">
  <div class="card-header bg-dark text-white">
    <h5 class="mb-0">Delivery Settings</h5>
  </div>



  <div class="card-body">

    <div>
        <h5 class="text-center">Current Delivery Status</h5>
        <hr class="w-100">
        <% if(delivery.type=== "fixed") { %>
            <p class="fw-semibold text-muted mb-2">Type: <span><%= delivery.type %></span></p>
            <p class="fw-semibold text-muted">Amount: <span><%= delivery.amount %></span> </p>
        <%}else if(delivery.type==="state"){%>
            <p class="fw-semibold text-muted">Type: <span><%= delivery.type %></span></p>
            <p class="fw-semibold text-muted  me-2 mb-4 position-relative">Applied:</p>
            <div class="d-flex align-items-center mb-5">
            <select name="nothing"  class="p-1 border  border-secondary rounded rounded-3 position-absolute" id="currentstatus" size="1" style="z-index: 999; width: 200px;">
                <option class="fw-semibold text-secondary" value="">Show Applied States</option>
                <% delivery.stateRules.forEach(rule=>{ %>
                    <option class="d-flex justify-content-between" disabled> <%=rule.state %> - <%= rule.charge %></option>
                 <%})%>   
            </select>
            </div>
         <%}%>       
    </div>
    <hr>
    <form id="deliveryForm" method="POST" action="/admin/delivery/save">
        <h5 class="text-center">Update</h5>
        <hr class="w-100">
      <!-- Delivery Type -->
      <div class="mb-3">
        <label class="form-label fw-semibold">Delivery Type</label>
        <select class="form-select" name="type" id="deliveryType" required>
          <option value="">-- Select Type --</option>
          <option value="fixed" >Fixed</option>
          <option value="state" >State-wise</option>
        </select>
      </div>

      <!-- Fixed Amount (hidden by default) -->
      <div id="fixedAmountGroup" class="mb-3 d-none">
        <label class="form-label fw-semibold">Delivery Charge (₹)</label>
        <input type="number" name="amount" class="form-control"
               
               min="0" placeholder="Enter delivery charge" value="<%= delivery.amount %>">
      </div>

      <!-- State-wise (hidden by default) -->
      <div id="stateChargeGroup" class="mb-3 d-none">
        <label class="form-label fw-semibold">Select State & Charge</label>
        <div class="row g-2">
          <div class="col-md-6">
            <select name="state" class="form-select">
              <% const statesList = [
                  "Kerala","Tamil Nadu","Karnataka","Andhra Pradesh","Telangana",
                  "Maharashtra","Delhi","Gujarat","Rajasthan","Punjab","Haryana",
                  "Uttar Pradesh","Madhya Pradesh","Bihar","West Bengal","Odisha"
              ]; %>
              <% statesList.forEach(function(st){ 
                 let rule = delivery && delivery.stateRules 
                ? delivery.stateRules.find(r => r.state === st) 
                : null;
              %>
             <option value="<%= st %>" <%= rule ? "selected" : "" %>>
           <%= st %> - <%= rule ? "₹" + rule.charge : "N/A" %>
             </option>
            <% }) %>

            </select>
          </div>
          <div class="col-md-6">
            <input type="number" name="charge" class="form-control"
                   value="<%= delivery && delivery.type === 'state' && delivery.stateRules && delivery.stateRules[0] ? delivery.stateRules[0].charge : '' %>"
                   min="0" placeholder="Enter charge">
          </div>
        </div>
      </div>
      <input type="hidden" id="deliveryId" value="<%= delivery._id %>" >
      <div class="d-flex align-items-center">
        <button type="submit" class="btn btn-sm btn-success mx-auto mt-3">Save Settings</button>
      </div>
    </form>
    <div id="messageBox" class="mt-3"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  const typeSelect = document.getElementById("deliveryType");
  const fixedGroup = document.getElementById("fixedAmountGroup");
  const stateGroup = document.getElementById("stateChargeGroup");

  function toggleFields() {
    if (typeSelect.value === "fixed") {
      fixedGroup.classList.remove("d-none");
      stateGroup.classList.add("d-none");
    } else if (typeSelect.value === "state") {
      fixedGroup.classList.add("d-none");
      stateGroup.classList.remove("d-none");
    } else {
      fixedGroup.classList.add("d-none");
      stateGroup.classList.add("d-none");
    }
  }

  // Run once on page load (to handle pre-selected option)
  toggleFields();

  // Run every time admin changes selection
  typeSelect.addEventListener("change", toggleFields);

  const form = document.getElementById("deliveryForm");
  const typeSelected = document.getElementById("deliveryType");
  const fixedInput = document.querySelector("input[name='amount']");
  const stateSelect = document.querySelector("select[name='state']");
  const chargeInput = document.querySelector("input[name='charge']");
  const messageBox = document.getElementById("messageBox");
  const deliveryId = document.getElementById("deliveryId").value;

  form.addEventListener("submit", async function (e) {
    e.preventDefault();
    messageBox.innerHTML = ""; // Clear previous messages

    const type = typeSelected.value;

    // --- Client-side validation ---
    if (!type) {
      messageBox.innerHTML = `<div class="alert alert-danger">Please select a delivery type.</div>`;
      return;
    }

    if (type === "fixed") {
      if (!fixedInput.value || isNaN(fixedInput.value) || fixedInput.value < 0) {
        messageBox.innerHTML = `<div class="alert alert-danger">Please enter a valid delivery charge.</div>`;
        return;
      }
    }

    if (type === "state") {
      if (!stateSelect.value) {
        messageBox.innerHTML = `<div class="alert alert-danger">Please select a state.</div>`;
        return;
      }
      if (!chargeInput.value || isNaN(chargeInput.value) || chargeInput.value < 0) {
        messageBox.innerHTML = `<div class="alert alert-danger">Please enter a valid charge for the state.</div>`;
        return;
      }
    }

    // --- Send data to server ---
    const formData = {
      type: type,
      amount: fixedInput.value,
      state: stateSelect.value,
      charge: chargeInput.value
    };

    try {
      const res = await fetch("/admin/delivery/save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({formData,deliveryId})
      });

      const result = await res.json();

      if (result.success) {
        Swal.fire({
            icon:"success",
            title:"Success",
            text:"Delivery charge updated successfully.",
            timer:1000,
            showConfirmationButton:false
        }).then(()=>{
            window.location.reload();
        })
      } else {
        messageBox.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
      }
    } catch (err) {
      console.error(err);
      messageBox.innerHTML = `<div class="alert alert-danger">Something went wrong. Try again.</div>`;
    }
  });


 document.addEventListener("DOMContentLoaded", () => {
  const selectBox = document.getElementById("currentstatus");
  if (selectBox) {
    selectBox.addEventListener("mouseover", () => selectBox.size = 5);
    selectBox.addEventListener("mouseout", () => selectBox.size = 1);
  }
});


</script>
<%- include("../partials/admin/footer.ejs") %>