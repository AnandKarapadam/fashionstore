<%- include("../partials/user/header.ejs") %>
  <%- include("../partials/user/navbar.ejs") %>
    <div class="container pt-5">
      <div class="payment-card text-center">
        <h3 class="fw-bold mb-3">Complete Your Payment</h3>
        <p class="text-muted">Pay securely using Razorpay for your order</p>
        <hr>

        <h4 class="mb-4">Amount: <span class="text-success fw-bold">₹<%= order.amount/100 %></span></h4>

        <button id="rzp-button" class="btn btn-dark btn-pay">
          Pay <span class="text-white fw-bold">₹<%= order.amount/100 %></span> Now
        </button>

        <div class="mt-4 text-muted small">
          <i class="bi bi-shield-lock"></i> Transactions are secured by Razorpay
        </div>
      </div>
    </div>

    <%- include("../partials/user/footer.ejs") %>
      <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
      <script>


        const selectedMethod = "<%= selectedMethod || '' %>";
        const options = {
          "key": "<%= key %>",
          "amount": "<%= order.amount %>",
          "currency": "INR",
          "name": "Fashion Store",
          "description": "Order Payment",
          "order_id": "<%= order.id %>",
          "handler": function (response) {
            fetch("/cart/checkout/razorpay/verify", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(response)
            }).then(res => res.json())
              .then(data => {
                if (data.success) {
                  window.location.href = "/cart/order-success";
                } else {
                  window.location.href = "/cart/order-failed"
                }
              });
          },
          "theme": {
            "color": "#000cc"
          }
        };

        if (selectedMethod === "card") {
          options.method = {
            card: true,
            upi: false,
            netbanking: false,
            wallet: false
          };
        } else if (selectedMethod === "upi") {
          options.method = {
            card: false,
            upi: true,
            netbanking: false,
            wallet: false
          };
        }
        document.getElementById("rzp-button").onclick = async function (e) {
          e.preventDefault();

          try {

            const queryParams = new URLSearchParams(window.location.search);
            const type = queryParams.get("type") || "all";
            const product = queryParams.get("productId") || queryParams.get("product") || null;
            const size = queryParams.get("size") || null;


            const res = await fetch("/cart/checkout/validate", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ type, product, size })
            });

            const data = await res.json();

           
            if (!data.success && data.redirectCart) {
              await Swal.fire({ icon: "warning", title: "Stock Issue", text: data.message });
              window.location.href = "/cart";
              return;
            }

   
            if (data.warnings && data.warnings.length > 0) {
              await Swal.fire({
                icon: "info",
                title: "Stock Adjusted",
                html: data.warnings.join("<br>")
              });

              let addressId = "<%= selectedAddressId || '' %>"; 
              let paymentUrl = `/cart/checkout/payment?addressId=${addressId}`;

              if (type === "single" && product && size) {
                paymentUrl += `&type=single&productId=${product}&size=${size}`;
              }

              window.location.href = paymentUrl;
              return;
            }


            const rzp1 = new Razorpay(options);

            rzp1.on('payment.failed', function (response) {
              console.log(response.error);
              window.location.href = "/cart/order-failed";
            });

            rzp1.on('checkout.dismiss', function () {
              window.location.href = "/cart/order-failed";
            });

            rzp1.open();

          } catch (err) {
            console.error("Validation or payment error:", err);
            Swal.fire({
              icon: 'error',
              title: 'Oops!',
              text: 'Something went wrong. Please try again.'
            });
          }
        };
      </script>
      </body>

      </html>