<%- include("../partials/user/header.ejs") %>
<%- include("../partials/user/navbar.ejs") %>

  <!-- Updated Row -->
  <!-- Bootstrap CSS & Icons -->


<div class="container mt-5 pt-5">
  <div class="row g-4 align-items-start">
    <!-- Product Details (Left) -->
    <div class="col-md-8 d-flex justify-content-md-center">
      <!-- Image & Rating -->
      <div class="me-4 text-center">
        <img src="/uploads/re-image/<%= orderItem.product.productImage[0] %>" alt="Product Image" class="img-fluid mb-2" style="width: 120px; height: 160px; object-fit: contain;">
        <p class="mb-1"><small class="fw-bold">Rate This Product</small></p>
        <% if (orderItem.product.ratings && orderItem.product.ratings.average > 0) { %>
  <div class="text-warning mb-2">
    <% for (let i = 1; i <= 5; i++) { %>
      <% if (i <= orderItem.product.ratings.average) { %>
        <i class="bi bi-star-fill"></i>
      <% } else { %>
        <i class="bi bi-star"></i>
      <% } %>
    <% } %>
    <span class="text-muted">(<%= orderItem.product.ratings.count %> reviews)</span>
  </div>
<% } else { %>
  <p class="text-muted">No reviews yet</p>
<% } %>

        <a href="/product-details/<%= orderItem.product._id%>#review-section" class="btn btn-dark btn-sm fw-semibold">Add Review</a>
      </div>

      <!-- Product Text Details -->
      <div>
        <p class="mb-2 fw-bold"><%= orderItem.product.productName %></p>
        <p class="mb-2 small">Color:<%= orderItem.product.color %></p>
        <p class="small fw-semibold mb-2">Order ID: <span class="text-muted"><%= orderItem.orderId %></span></p>
        <p class="small fw-semibold">Item ID: <span class="text-muted"><%= orderItem.orderItemId %></span></p>
        <p class="fw-bold fs-5 mb-0 text-success">₹<%= orderItem.product.salePrice %></p>
        <p class="text-  small mt-4" style="font-size: 12px;">Status: <span class="text-muted fw-bold"><%= orderItem.status %></span></p>
      </div>
    </div>

    <!-- Tracking (Right) -->
    <div class="col-md-4">
      <div class="container ">
  <h5 class="fw-bold mb-4">Order Tracking</h5>

  <div class="tracking-wrapper">
    <!-- Grey base line -->
    <div class="tracking-line"></div>

    <!-- Green progress overlay -->
    <div class="tracking-line-progress" style="height: 75%;"></div> <!-- Change this -->

    <!-- Step 1 -->
    <div class="tracking-step">
      <div class="circle"></div>
      <div class="label">Order Placed</div>
    </div>

    <!-- Step 2 -->
    <div class="tracking-step">
      <div class="circle"></div>
      <div class="label">Shipped</div>
    </div>

    <!-- Step 3 -->
    <div class="tracking-step">
      <div class="circle"></div>
      <div class="label">Out for Delivery</div>
    </div>

    <!-- Step 4 -->
    <div class="tracking-step">
      <div class="circle"></div>
      <div class="label">Delivered</div>
    </div>
  </div>
  <% if(orderItem.status === "Cancelled"){%>
    <div><p class="d-flex align-items-start mt-2 fw-bold text-danger"><span>cancelled</span></p></div>
  <%}else if(orderItem.status === "Return Request") {%>
    <div><p class="d-flex align-items-start mt-2 fw-bold text-danger"><span>Return Requested</span></p></div>
  <%}%>    
</div>
    </div>
  </div>

  <div class="row mt-4">

    <div class="col-md-6 px-5 ">
      <div class="border border-1 h-100 rounded-4 p-3 shadow-sm">
      <p class="text-muted small">Product Details</p>
      <hr>
      <div class="d-flex justify-content-between">
        <p class="small">List Price</p>
        <p class="small fw-bold">₹<%= orderItem.product.regularPrice %></p>
      </div>
      <div class="d-flex justify-content-between">
        <p class="small">Selling Price</p>
        <p class="small fw-bold">₹<%= orderItem.product.salePrice %></p>
      </div>
      <div class="d-flex justify-content-between">
        <p class="small">Discount</p>
        <p class="small fw-bold">%<%= orderItem.product.productOffer %></p>
      </div>
      <div class="d-flex justify-content-between">
        <p class="small">Platform Fee</p>
        <p class="small fw-bold">₹0</p>
      </div>
      <hr>
      <div class="d-flex justify-content-between">
        <p class="small">Total Amount</p>
        <p class="small fw-bold text-success">₹<%= orderItem.product.salePrice %></p>
      </div>
      </div>
    </div>
    <div class="col-md-6 px-5 mt-3 mt-md-0">
      <div class="border border-1 h-100 rounded-4 p-3 shadow-sm">
      <p class="text-muted small">Shipping Details</p>
      <hr>
        <p class="small"><%= orderItem.address.name %></p> 
        <p class="small"><%= orderItem.address.address %></p>
        <p class="small"><%= orderItem.address.city %></p>
        <p class="small">PIN:<%= orderItem.address.pincode %></p>
        <p class="small">Phone:<%= orderItem.address.phone %></p>    
      <hr>
      </div>
    </div>
  </div>
  <div class="text-center">
    <a href="/invoice/download/<%= orderItem.order_id %>/<%= orderItem.product._id %>" class="btn btn-outline-dark mt-4">
  <i class="bi bi-download me-1"></i> Download Invoice
</a>
  </div>
</div>
<div id="order-status" style="display:none;"><%= orderItem.status %></div>

  <%- include("../partials/user/footer.ejs") %>
  <script>
document.addEventListener("DOMContentLoaded", () => {
  const status = document.getElementById("order-status").textContent.trim();

  const stepIndexMap = {
    "Pending": 0,
    "Processing": 0, 
    "Shipped": 1,
    "Out for Delivery": 2,
    "Delivered": 3,
    // "Cancelled": 0,
    // "Return Request": 0,
    "Returned": 3
  };

  const statusProgressMap = {
    
    0: 10,
    1: 50,
    2: 75,
    3: 100,
    
  };

  const completedIndex = stepIndexMap[status] ?? -1;
  const percent = statusProgressMap[completedIndex] || 0;

   const progressLine = document.querySelector(".tracking-line-progress");
  progressLine.style.height = "0%"; // start collapsed
  progressLine.style.transition = "height 1.5s ease-in-out"; // animate change
  setTimeout(() => {
    progressLine.style.height = percent + "%"; // animate to desired height
  }, 100);

 

  document.querySelectorAll(".tracking-step").forEach((step, i) => {
    if (i <= completedIndex) {
      step.classList.add("completed");
    }
  });
});
</script>

</body>

</html>