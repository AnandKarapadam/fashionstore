<%- include("../partials/user/header.ejs") %>
<%- include("../partials/user/navbar.ejs") %>

    <div class="row mt-5 pt-5">
        <div class="col-md-3 mt-5 d-none d-lg-block" >
    <div class="sidebar-content ms-5 w-100" style="position: sticky;top: 100px;">
        <div class="bg-dark rounded-3 mb-4">
            <h6 class="text-white d-flex align-items-center py-3 ps-2 text-truncate"><i class="bi bi-person-circle fs-4 me-2"></i>Hello Anand KV</h6>
        </div>
        <ul class="nav flex-column ">
          <li class="nav-item"><a class="nav-link text-dark border" href="/profile"><i class="bi bi-person-circle me-2"></i> Profile</a></li>
          <li class="nav-item"><a class="nav-link text-dark border" href="/orders"><i class="bi bi-inboxes-fill me-2"></i> Orders</a></li>
          <li class="nav-item"><a class="nav-link text-dark border" href="/wallet"><i class="bi bi-wallet me-2"></i> Wallet</a></li>
          <li class="nav-item"><a class="nav-link text-dark border" href="/address"><i class="bi bi-geo me-2"></i> Address</a></li>
          <li class="nav-item"><a class="nav-link text-dark border text-truncate" href="/delete-account"><i class="bi bi-trash2-fill me-2"></i> Delete Account</a></li>
          <li class="nav-item"><a class="nav-link text-dark border" href="/logout"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
        </ul>
      </div>
        </div>
        <div class="col-md-9 mt-3 mb-5 mx-auto" >
            <div id="mainContent" class="main-content container">
    <div class="card shadow rounded-4 mx-auto p-4" style="max-width: 600px;">
      <h4 class="card-title text-center mb-4 fw-bold">EDIT ADDRESS</h4>
    <form id="addressForm" action="/edit-address/<%= address._id %>" method="post">
      <div class="row mb-2">
        <div class="col-md-6">
            <label for="name" class="fw-bold label">Name</label>
            <input type="text" name="name" id="name" value="<%= address.name %>" class="form-control bg-light form-control-sm" placeholder="Enter name">
            <div class="text-danger small" id="nameError"></div>
        </div>
        <div class="col-md-6">
            <label for="phone" class="fw-bold label">Mobile Number</label>
            <div class="input-group">
      <!-- Country Code Dropdown -->
    <select id="countryCode" name="countryCode" class="form-select form-select-sm bg-light no-arrow fw-semibold"  style="max-width:50px; -webkit-appearance:none; -moz-appearance:none; appearance:none; background-image:none; padding-right:6px;border-right: 2px solid rgb(167, 167, 167);border: 2px solid rgb(208, 208, 208) ;">
      <option value="+91" selected>+91</option>
      <option value="+1">+1</option>
      <option value="+44">+44</option>
      <option value="+61">+61</option>
      <option value="+971">+971</option>
    </select>

    <!-- Phone Number Input -->
    <input type="text" id="phone" name="phone" class="form-control bg-light form-control-sm" value="<%= address.phone %>" placeholder="Enter Phone">
  </div>
            <div class="text-danger small" id="phoneError"></div>
        </div>
      </div>
      <div class="row mb-2">
        <div class="col-md-6">
            <label for="pin" class="fw-bold label">PIN Code</label>
            <input type="text" name="pincode" id="pin" class="form-control bg-light form-control-sm" value="<%= address.pincode %>" placeholder="Enter PIN code">
            <div id="pincodeSuggestion" class="list-group position-absolute" style="z-index:1000; max-height:200px ;overflow-y:auto;margin-top: 10px;"></div>
            <div class="text-danger small" id="pinError"></div>
        </div>
        <div class="col-md-6">
            <label for="locality" class="fw-bold label">Locality</label>
            <input type="text" name="locality" id="locality" class="form-control bg-light form-control-sm" value="<%= address.locality %>" placeholder="Your Locality">
            <div class="text-danger small" id="localityError"></div>
        </div>
      </div>

      <div class="row mb-2">
        <div class="col-md-12 d-flex flex-column">
            <label for="address" class="fw-bold label">Address</label>
            <textarea name="address" name="address" id="address" rows="3" placeholder="Your address" class="form-control bg-light" style="position: relative;"><%= address.address %></textarea>
            <div id="addressSuggestions" class="list-group position-absolute" style="z-index:1000; max-height:200px ;overflow-y:auto;margin-top: 50px;"></div>
            <div class="text-danger small" id="addressError"></div>
        </div>
      </div>
      <div class="row mb-2">
        <div class="col-md-6">
            <label for="city" class="fw-bold label">City/Dist/Town</label>
            <input type="text" id="city" name="city" class="form-control bg-light form-control-sm" value="<%= address.city %>" placeholder="Enter city/dist/town">
            <div class="text-danger small" id="cityError"></div>
        </div>
        <div class="col-md-6">
            <label for="state" class="fw-bold label">State</label>
            <select name="state" id="state"  class="form-select form-select-sm bg-light">
              <option disabled <%= !address.state ? ' selected' : '' %>>--- Select State ---</option>

                <option value="Andhra Pradesh" <%=address.state==='Andhra Pradesh' ? 'selected' : '' %>>Andhra Pradesh
                </option>
                <option value="Arunachal Pradesh" <%=address.state==='Arunachal Pradesh' ? 'selected' : '' %>>Arunachal
                  Pradesh</option>
                <option value="Assam" <%=address.state==='Assam' ? 'selected' : '' %>>Assam</option>
                <option value="Bihar" <%=address.state==='Bihar' ? 'selected' : '' %>>Bihar</option>
                <option value="Chhattisgarh" <%=address.state==='Chhattisgarh' ? 'selected' : '' %>>Chhattisgarh
                </option>
                <option value="Goa" <%=address.state==='Goa' ? 'selected' : '' %>>Goa</option>
                <option value="Gujarat" <%=address.state==='Gujarat' ? 'selected' : '' %>>Gujarat</option>
                <option value="Haryana" <%=address.state==='Haryana' ? 'selected' : '' %>>Haryana</option>
                <option value="Himachal Pradesh" <%=address.state==='Himachal Pradesh' ? 'selected' : '' %>>Himachal
                  Pradesh</option>
                <option value="Jharkhand" <%=address.state==='Jharkhand' ? 'selected' : '' %>>Jharkhand</option>
                <option value="Karnataka" <%=address.state==='Karnataka' ? 'selected' : '' %>>Karnataka</option>
                <option value="Kerala" <%=address.state==='Kerala' ? 'selected' : '' %>>Kerala</option>
                <option value="Madhya Pradesh" <%=address.state==='Madhya Pradesh' ? 'selected' : '' %>>Madhya Pradesh
                </option>
                <option value="Maharashtra" <%=address.state==='Maharashtra' ? 'selected' : '' %>>Maharashtra</option>
                <option value="Manipur" <%=address.state==='Manipur' ? 'selected' : '' %>>Manipur</option>
                <option value="Meghalaya" <%=address.state==='Meghalaya' ? 'selected' : '' %>>Meghalaya</option>
                <option value="Mizoram" <%=address.state==='Mizoram' ? 'selected' : '' %>>Mizoram</option>
                <option value="Nagaland" <%=address.state==='Nagaland' ? 'selected' : '' %>>Nagaland</option>
                <option value="Odisha" <%=address.state==='Odisha' ? 'selected' : '' %>>Odisha</option>
                <option value="Punjab" <%=address.state==='Punjab' ? 'selected' : '' %>>Punjab</option>
                <option value="Rajasthan" <%=address.state==='Rajasthan' ? 'selected' : '' %>>Rajasthan</option>
                <option value="Sikkim" <%=address.state==='Sikkim' ? 'selected' : '' %>>Sikkim</option>
                <option value="Tamil Nadu" <%=address.state==='Tamil Nadu' ? 'selected' : '' %>>Tamil Nadu</option>
                <option value="Telangana" <%=address.state==='Telangana' ? 'selected' : '' %>>Telangana</option>
                <option value="Tripura" <%=address.state==='Tripura' ? 'selected' : '' %>>Tripura</option>
                <option value="Uttar Pradesh" <%=address.state==='Uttar Pradesh' ? 'selected' : '' %>>Uttar Pradesh
                </option>
                <option value="Uttarakhand" <%=address.state==='Uttarakhand' ? 'selected' : '' %>>Uttarakhand</option>
                <option value="West Bengal" <%=address.state==='West Bengal' ? 'selected' : '' %>>West Bengal</option>
                <option value="Andaman and Nicobar Islands" <%=address.state==='Andaman and Nicobar Islands'
                  ? 'selected' : '' %>>Andaman and Nicobar Islands</option>
                <option value="Chandigarh" <%=address.state==='Chandigarh' ? 'selected' : '' %>>Chandigarh</option>
                <option value="Dadra and Nagar Haveli and Daman and Diu"
                  <%=address.state==='Dadra and Nagar Haveli and Daman and Diu' ? 'selected' : '' %>>Dadra and Nagar
                  Haveli and Daman and Diu</option>
                <option value="Delhi" <%=address.state==='Delhi' ? 'selected' : '' %>>Delhi</option>
                <option value="Jammu and Kashmir" <%=address.state==='Jammu and Kashmir' ? 'selected' : '' %>>Jammu and
                  Kashmir</option>
                <option value="Ladakh" <%=address.state==='Ladakh' ? 'selected' : '' %>>Ladakh</option>
                <option value="Lakshadweep" <%=address.state==='Lakshadweep' ? 'selected' : '' %>>Lakshadweep</option>
                <option value="Puducherry" <%=address.state==='Puducherry' ? 'selected' : '' %>>Puducherry</option>
                </select>
                <div class="text-danger small" id="stateError"></div>
    </div>
    </div>
    <div class="row mb-2">
      <div class="col-md-6">
        <label for="landmark" class="fw-bold label">Landmark</label>
        <input type="text" id="landmark" name="landMark" value="<%= address.landMark %>" class="form-control bg-light form-control-sm" placeholder="Enter landmark">
        <div class="text-danger small" id="landmarkError"></div>
      </div>
      <div class="col-md-6">
        <label for="alt-number" class="fw-bold label">Alternative Mobile Number</label>
        <input type="text" id="alt-number" name="altPhone" value="<%= address.altPhone %>" class="form-control bg-light form-control-sm" placeholder="Your Locality">
        <div class="text-danger small" id="altPhoneError"></div>
      </div>
    </div>

    <div class="row d-flex flex-row mt-2 mb-2">
      <div class="col-sm-6">
        <label for="home" class="fw-bold label">Home</label>
        <input type="radio" name="addressType" id="home" class="margin-right" value="home"  <%= address.addressType === 'home' ? 'checked' : '' %>>
        <label for="work" class="fw-bold label">Work</label>
        <input type="radio" name="addressType" id="work" value="work"  <%= address.addressType === 'work' ? 'checked' : '' %>>
        <div class="text-danger small" id="addressTypeError"></div>
      </div>
      <div class="col-sm-6 text-end">
        <button type="submit" class="btn btn-dark btn-sm">Save</button>
        <a href="/address" class="btn btn-outline-dark btn-sm">Cancel</a>
      </div>
    </div>
    </form>
    </div>
    </div>
    </div>
    </div>
    <%- include("../partials/user/footer.ejs") %>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <% if( typeof message !== "undefined" ){ %>

        <script>
          Swal.fire({
            icon:"error",
            title:"error occured",
            text:"<%= message||'Internal error!, cannot edit address!'%>",
            timer:2000,
            showConfirmButton:false
          })
        </script>
      <% } %>
    
    <script>


    const pinInput = document.getElementById("pin");
const cityInput = document.getElementById("city");
const stateInput = document.getElementById("state");
const localityInput = document.getElementById("locality");
const pinSuggestionBox = document.getElementById("pincodeSuggestion");

pinInput.addEventListener("input", async () => {
  const pin = pinInput.value.trim();

  // Clear old suggestions
  pinSuggestionBox.innerHTML = "";

  if (pin.length === 6) {
    try {
      const res = await fetch(`https://api.postalpincode.in/pincode/${pin}`);
      const data = await res.json();

      if (data[0].Status === "Success" && data[0].PostOffice.length > 0) {
        // Create suggestion buttons
        pinSuggestionBox.innerHTML = data[0].PostOffice.map(po => `
          <button type="button" 
                  class="list-group-item list-group-item-action"
                  data-locality="${po.Name}"
                  data-city="${po.District}"
                  data-state="${po.State}">
            ${po.Name}, ${po.District}, ${po.State}
          </button>
        `).join("");

        // Attach click handlers
        pinSuggestionBox.querySelectorAll("button").forEach(btn => {
          btn.addEventListener("click", () => {
            cityInput.value = btn.dataset.city;
            stateInput.value = btn.dataset.state;
            localityInput.value = btn.dataset.locality;
            pinSuggestionBox.innerHTML = ""; // hide suggestions
            document.getElementById("pinError").textContent = ""
          });
        });

      } else {
        cityInput.value = "";
        stateInput.value = "";
        localityInput.value = "";
        document.getElementById("pinError").textContent = " Invalid Pincode";
      }
    } catch (err) {
      console.error("Error fetching pincode", err);
    }
  } else {
    cityInput.value = "";
    stateInput.value = "";
    localityInput.value = "";
  }
});

// Close suggestions if clicked outside
document.addEventListener("click", e => {
  if (!pinInput.contains(e.target) && !suggestionBox.contains(e.target)) {
    pinSuggestionBox.innerHTML = "";
  }
});

function debounce(func, delay) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), delay);
  };
}

const addressInput = document.getElementById('address');
const suggestionBox = document.getElementById('addressSuggestions');

// Make parent relative to position suggestions correctly
addressInput.parentElement.style.position = 'relative';

const fetchSuggestions = async()=>{

    const query = addressInput.value.trim();
    if (!query) {
        suggestionBox.innerHTML = '';
        return;
    }

    // Call Nominatim API
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=10`);
    const data = await res.json();

    // Display suggestions
    suggestionBox.innerHTML = data.map(place => `
        <button type="button" class="list-group-item list-group-item-action" 
            data-display="${place.display_name}" 
            data-lat="${place.lat}" 
            data-lon="${place.lon}">
            ${place.display_name}
        </button>
    `).join('');

    // Click on suggestion
    document.querySelectorAll('#addressSuggestions button').forEach(btn => {
        btn.addEventListener('click', () => {
            addressInput.value = btn.dataset.display;
            suggestionBox.innerHTML = '';
            console.log('Selected coordinates:', btn.dataset.lat, btn.dataset.lon);
        });
    });

}
addressInput.addEventListener('input', debounce(fetchSuggestions, 300));

// Close suggestions if clicked outside
document.addEventListener('click', e => {
    if (!addressInput.contains(e.target) && !suggestionBox.contains(e.target)) {
        suggestionBox.innerHTML = '';
    }
});

      document.getElementById("addressForm").addEventListener("submit",(e)=>{
        let hasError = false;

        const fields = ['name','phone','pin','locality','adderss','city','state','landmark','alt-number','addressType'];

        fields.forEach((id)=>{
          const errorDiv =  document.getElementById(id+'Error')||document.getElementById("altPhoneError")||document.getElementById("addressTypeError");
          if(errorDiv){
            errorDiv.innerText = "";
          }
        })

         const name = document.getElementById('name').value.trim();
         const phone = document.getElementById('phone').value.trim();
         const pin = document.getElementById('pin').value.trim();
         const locality = document.getElementById('locality').value.trim();
         const address = document.getElementById('address').value.trim();
         const city = document.getElementById('city').value.trim();
         const state = document.getElementById('state').value;
         const landmark = document.getElementById('landmark').value.trim();
         const altPhone = document.getElementById('alt-number').value.trim();
         const addressTypeWork = document.getElementById('work').checked;
         const addressTypeHome = document.getElementById('home').checked;

         const phoneRegex = /^\d{10}$/;
         const pinRegex = /^\d{6}$/;

         if(name===''){
          document.getElementById("nameError").innerText = "Name is required";
          hasError = true;
         }
         if(!phoneRegex.test(phone)){
          document.getElementById("phoneError").innerText = "Phone must be 10 numbers";
          hasError = true;
         }
         if(!pinRegex.test(pin)){
          document.getElementById("pinError").innerText = "PIN must be 6 digits";
          hasError = true;
         }
         if(locality === ""){
          document.getElementById("localityError").innerText = "Locality is required";
          hasError = true;
         }

         if(address === ""){
          document.getElementById("addressError").innerText = "Adderss is required";
          hasError = true;
         }

         if(city === ""){
          document.getElementById("cityError").innerText = "City is required";
          hasError = true;
         }

         if(landmark === ""){
          document.getElementById("landmarkError").innerText = "Landmark is required";
          hasError = true
         }
         

         if(!state){
          document.getElementById("stateError").innerText = "State is required";
          hasError = true;
         }

         if(altPhone === ""){
          document.getElementById("altPhoneError").innerText = "Alternate Number is required."
          hasError = true;
         }
          else if(altPhone !== ""){
          if(!phoneRegex.test(altPhone)){
            document.getElementById("altPhoneError").innerText = "Alternate number must be 10 digits";
            hasError =  true;
          }else if(altPhone === phone){
            document.getElementById("altPhoneError").innerText = "Alternate number must be different from phone";
            hasError = true;
          }
         }

         if(!addressTypeHome && !addressTypeWork){
          document.getElementById("addressTypeError").innerHTML = "Please select home/work";
          hasError = true;
         }

         if (hasError){
          e.preventDefault();   
         }


      })
    </script>
</body>

</html>