<%- include("../partials/user/header.ejs") %>
<%- include("../partials/user/navbar.ejs") %>
 
  <!-- Updated Row -->
  <div class="row pt-4 mt-5 mx-md-3 align-items-start">
    <!-- Cart Section -->
    <div class="col-md-8 mt-5 px-4">
      <div class="border p-4 mb-3 rounded shadow-sm">
        <% if(products.length>0){ %>
          <% products.forEach((product)=>{%>
        <div class="row shadow-sm rounded-3 bg-light p-3 mb-3 align-items-top">
          <div class="col-md-4 text-center">
           <a href="/product-details/<%= product._id %>"><img src="/uploads/re-image/<%= product.image %>" alt="Product Image" class="img-fluid rounded" style="max-height: 150px;"></a>
            <p class="small mt-2 fw-semibold">Quantity: <span class="fw-bold"><%= product.quantity %></span></p>
          </div>
          <div class="col-md-8">
            <div>
               <h5 class="fw-bold mb-1"><%= product.name %></h5>
               <p class="mb-1 text-muted small fw-semibold">Address: <span class="text-break fw-normal"><%= address.address %></span></p>
               <span class="small text-muted">Phone:<%= address.phone %></span><br>
               <span class="small text-muted">PIN:<%= address.pincode %></span>
            </div>
            
            <div class="d-flex justify-content-between mt-5">
              
                <p><%= address.addressType.toUpperCase() %></p>
              
              
                <h5 class="text-success">₹<%= product.price %></h5>
              
            </div>
          
          </div>
        </div>
        <% }) %>
        <%} else{ %>
            <h4 class="text-center fw-bold">No products found</h4>
          <% } %>
        <!-- Pagination -->
          <% if(products){ %>
        <div class="container mt-3" id="paginationSection">
          <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mb-4" style="margin-right: -50px;">
              <% const maxVisiblePages = 3;
              let startPage = Math.max(1, currentPage - 1);
              let endPage = startPage + maxVisiblePages - 1;
              if (endPage > totalPages) {
                endPage = totalPages;
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
              } %>

              <li class="page-item <%= currentPage == 1 ? 'disabled' : '' %>">
                <a class="page-link" href="?page=<%= parseInt(currentPage) - 1 %>&search=<%= search %>">&laquo;</a>
              </li>

              <% for (let i = startPage; i <= endPage; i++) { %>
                <li class="page-item <%= i == currentPage ? 'active' : '' %>">
                  <a class="page-link" href="?page=<%= i %>&search=<%= search %>"><%= i %></a>
                </li>
              <% } %>

              <li class="page-item <%= currentPage == totalPages ? 'disabled' : '' %>">
                <a class="page-link" href="?page=<%= parseInt(currentPage) + 1 %>&search=<%= search %>">&raquo;</a>
              </li>
            </ul>
          </nav>
        </div>
        <% } %>
      </div>
    </div>

    <!-- Order Summary Section -->
    <div class="col-4 mt-5 d-none d-md-block">
      <div class="p-3 shadow-sm border rounded-3" style="position: sticky; background-color: rgb(212, 212, 212); top: 120px;">
        <div class="mb-1">
          <h5 class="fw-bold text-center">Order Summary</h5>
        </div>
        <div class="bg-light p-2 rounded-3">
          
          <% products.forEach((product)=>{%>
          <div class="d-flex justify-content-between mb-2">
            <div><span class="fw-semibold"><%= product.quantity %> × <%= product.name %></span></div>
            <div><span class="fw-semibold text-success">₹<%= product.quantity* product.price %></span></div>
          </div>
          <% }) %>
          <div class="d-flex justify-content-between small text-success fw-semibold mb-2">
            <div>Delivery Charges</div>
            <div class="text-success">Free</div>
          </div>
          <% if(discount && discount>0){%>
            <div class="d-flex justify-content-between small text-danger fw-semibold mb-2">
             <div>Discount</div>
             <div>-₹<%= discount||0 %></div>
            </div>
          <%} %>  
          <div class="d-flex justify-content-between small text-muted mb-3">
            <div>Platform Fee</div>
            <div>₹0</div>
          </div>

        </div>
        
        <hr>
        <div class="d-flex justify-content-between mb-3 bg-light rounded-3 p-3">
          <div class="fw-bold">Total <br> <small class="text-muted fw-normal">In rupees</small></div>
          <div class="fw-bold text-success">₹<%= totalAmount %></div>
        </div>
        <button onclick="postOrders('<%= paymentMethod %>','<%= address._id %>','<%= type %>','<%= product %>')" class="btn btn-dark w-100 fw-semibold">Confirm Order</button>
      </div>
    </div>
  </div>

  <%- include("../partials/user/footer.ejs") %>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    function changeQty(btn, delta) {
      const input = btn.parentElement.querySelector("input");
      let value = parseInt(input.value) || 1;
      value += delta;
      if (value < 1) value = 1;
      input.value = value;
    }
    async function postOrders(paymentMethod,addressId,type,product) {
      try {

        const res =await fetch("/cart/checkout/confirm",{
          method:"POST",
          headers:{
            'Content-Type':"application/json"
          },
          body:JSON.stringify({paymentMethod,addressId,type,product})
        })
        
        if(res.ok){
          const data = await res.json();
          window.location.href = "/cart/order-success"
        }
        else{
          const data = await res.json();
          Swal.fire({
            icon:"error",
            title:"Error Occured!",
            text:data.message||"Cannot confirm order"
          })
        }
        
      } catch (error) {
        console.error("Error:",error.message);
      }
    }
  </script>
</body>

</html>
