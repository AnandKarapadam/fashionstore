<%- include("../partials/user/header.ejs") %>
<%- include("../partials/user/navbar.ejs") %>


<div class="row mt-5 pt-5">
    
    <div class="col-md-12 mb-5  mt-3 mx-auto">
      <div id="mainContent" class="main-content pt-5 pb-5 container">
        <div class="card shadow rounded-4 mx-auto p-4" style="max-width: 600px;">
          <h4 class="card-title text-center mb-1 fw-bold">Pay From Wallet <i class="bi text-dark bi-wallet2"></i></h4>
          <hr>
          <form id="walletPaymentForm" action="/cart/checkout/wallet" method="post">
            <div class="d-flex align-items-center justify-content-center">
              <p class="text-center fw-semibold">Available Amount</p>
            </div>
            <input type="hidden" name="amount" value="<%= wallet.balance||0%>">
            <div class="d-flex align-items-center justify-content-center">
              <p class="fs-1 text-success fw-bold">&#8377<span id="walletAmount" >0</span> </p>
            </div>
            <hr>
              
      
            <div class="d-flex align-items-center justify-content-center">
              <button class="btn btn-primary fw-bold">Pay &#8377<span><%= orderData?.finalAmount %></span></button>
            </div>
            <input type="hidden" id="addressId" value="<%= addressId %>">

          </form>


        </div>
      </div>
    </div>
  </div>


<%- include("../partials/user/footer.ejs") %>
<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<% if(typeof message !== undefined && message){ %>
<script>
    Swal.fire({
        icon:"error",
        title:"Error",
        text:"<%= typeof message !== 'undefined' && message ? message : '' %>",
        showConfirmButton: false,
        timer: 2000
    })
</script>
<%}%>
<script>
    function animateValue(element, start, end, duration) {
  let startTimestamp = null;

  const step = (timestamp) => {
    if (!startTimestamp) startTimestamp = timestamp;
    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
    const value = Math.floor(progress * (end - start) + start);
    element.textContent = value.toLocaleString("en-IN");
    if (progress < 1) {
      window.requestAnimationFrame(step);
    }
  };

  window.requestAnimationFrame(step);
}

document.addEventListener("DOMContentLoaded", () => {
  let el = document.getElementById("walletAmount");
  let end = parseInt(document.querySelector("input[name='amount']").value, 10);
  animateValue(el, 0, end, 1500);
});

document.getElementById("walletPaymentForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  try {
    const urlParams = new URLSearchParams(window.location.search);
    const type = urlParams.get("type");
    const product = urlParams.get("product");
    const size = urlParams.get("size");
   const addressId = urlParams.get("addressId") || document.getElementById("addressId").value;


    // Call validate stock API
    const res = await fetch(`/cart/checkout/validate-stock?${urlParams.toString()}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
    });
    const data = await res.json();

    // If stock issue or any removal
    if (!data.success || data.redirectCart) {
      let msg = "";
      data.messages?.forEach(item => {
        msg += `• ${item.message}<br>`;
      });

      await Swal.fire({
        icon: 'warning',
        title: 'Stock Update',
        html: msg,
        confirmButtonText: 'Go to Cart'
      });

      return window.location.href = "/cart";
    }

    // If quantity adjusted but still available
    if (data.messages.length > 0) {
      let msg = "";
      data.messages.forEach(item => {
        msg += `• ${item.message}<br>`;
      });

      await Swal.fire({
        icon: 'info',
        title: 'Stock Updated',
        html: msg,
        confirmButtonText: 'Proceed to Payment'
      });

      // Redirect to payment page with proper query
      let redirectUrl = `/cart/checkout/payment?addressId=${addressId}`;
      if (type === "single") {
        redirectUrl += `&type=${type}&productId=${product}&size=${size}`;
      }
      return window.location.href = redirectUrl;
    }

    // No warnings, submit form normally
    e.target.submit();

  } catch (err) {
    console.error(err);
    Swal.fire({
      icon: 'error',
      title: 'Oops!',
      text: 'Something went wrong. Please try again.'
    });
  }
});

</script>