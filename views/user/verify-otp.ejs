<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OTP Verification</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" />

  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.22.2/dist/sweetalert2.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    body {
      background-color: #f4f4f4;
      font-family: 'Segoe UI', sans-serif;
    }

    .otp-box {
      /* background: #fff; */
      padding: 25px 20px;
      /* border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); */
     
      text-align: center;
    }

    .otp-input-group {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .otp-input {
      width: 45px;
      height: 50px;
      font-size: 24px;
      text-align: center;
      border: 2px solid #ced4da;
      border-radius: 8px;
      transition: 0.2s;
    }

    .otp-input:focus {
      border-color: #0d6efd;
      outline: none;
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
    }

    #resendLink {
      
      cursor: pointer;
      font-weight: 500;
    }

    .bottom-links {
      margin-top: 20px;
    }

    .bottom-links a {
      text-decoration: none;
      font-size: 14px;
    }

    .bottom-links a:hover {
      text-decoration: underline;
    }
    
  </style>
</head>
<body>

<div class="container min-vh-100 d-flex align-items-center justify-content-center">
<div class="row justify-content-center align-items-center shadow-sm border border-1 border-light rounded-4 bg-white">
  <div class="col-md-6">
<div class="otp-box">
  
  <h4 class="mb-3 fw-semibold">Verify OTP</h4>
  <p class="text-muted mb-4">Enter the 5-digit code sent to your email or phone.</p>

  <form id="otpForm" >
    <div class="otp-input-group">
      <% for (let i = 0; i < 5; i++) { %>
        <input type="text"  class="otp-input"  maxlength="1" required />
      <% } %>
    </div>
    <div class="d-flex justify-content-center">
    <button type="submit" class="btn btn-dark fw-semibold w-50">Verify</button>
    </div>
  </form>

  <div class="text-center mt-2 mb-3">
              <button  id="countdown" class="border-0" disabled>
                 (00:45)
              </button>
   </div>
  <div>
    <button id="resendLink" onclick="return resendOTP(event)" class="btn btn-link p-0 text-primary small" >Resend OTP</button>
  </div>

  <div class="bottom-links mt-4">
    <p class="text-muted mb-0">Go to login page
      <a href="/login" class="text-primary">Login here</a>
    </p>
  </div>
  </div>
 

</div>
<div class="col-md-6 d-none d-md-flex align-items-center justify-content-center">
  <img src="/images/otp-img.jpg" style="width: 350px;height: 350px;" alt="">
</div>
</div>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.22.2/dist/sweetalert2.all.min.js"></script>
<script>
  document.getElementById("otpForm").addEventListener("submit",function(e){
    e.preventDefault();
    const inputOtp = document.querySelectorAll(".otp-input");
    let otp = "";
    for(let input of inputOtp){
      const val = input.value.trim();

      if(val === "" || isNaN(val)){
        Swal.fire({
          icon:"warning",
          title:"Invalid OTP",
          text:"Please enter all five digits.",
          confirmButtonColor:"#3085d6"
        })
        input.focus();
        return false;
      }
      otp+=val;
    }

    $.ajax({
      type:"POST",
      url:"/verify-otp",
      data:{
        otp:otp
      },
      success:function(response){
        if(response.success){
          Swal.fire({
            icon:"success",
            title:"OTP Verified!",
            showConfirmButton:false,
            timer:1500
          }).then(() => {
            console.log(response.redirectUrl)
            window.location.href = response.redirectUrl;
          })
        }else{
          Swal.fire({
            icon:"error",
            title:"Invalied OTP",
            text:response.message
          })
        }
      },
      error:function(){
        Swal.fire({
          icon:"error",
          title:"Error",
          text:"Failed to verify OTP please try again"
        })
      }
    })
    return false;
  })

  let otptimer = 60;
  let otpTimeInterval;
  const button = document.getElementById("countdown");

  function updateTextColor(percentage){
    if(percentage > 50){
      button.style.color = "#28a745";
    }
    else if(percentage>25){
      button.style.color = "#ffc107";
    }
    else{
      button.style.color = "#dc3545";
    }
  }

  function startOtpTimer (){
    otpTimeInterval = setInterval(()=>{
      const minutes = Math.floor(otptimer/60);
      const second = otptimer%60;
      
      button.textContent = `${minutes}:${second<10?"0":''}${second}`;
      updateTextColor((otptimer/60)*100);

      if(--otptimer<0){
        clearInterval(otpTimeInterval);
        button.textContent = "Expired";
        button.style.color = "red";
      }

    },1000)
  }
  initializeOtpTimer();

  function initializeOtpTimer(){
    clearInterval(otpTimeInterval);
    otptimer = 60;
    startOtpTimer();
  }

  function resendOTP(){
    clearInterval(otpTimeInterval);
    otptimer = 60;
    startOtpTimer();

    $.ajax({
      type:"POST",
      url:"/resend-otp",
      success:function(response){
        if(response.success){
          Swal.fire({
            icon:"success",
            title:"Success",
            text:response.message,
            showConfirmButton:false,
            timer:1500
          })
        }else{
          Swal.fire({
            icon:"warning",
            title:"Error",
            text:response.message
          })
        }
      },
      error:function(){
        Swal.fire({
          icon:"error",
          title:"Error",
          text:"Failed to resend OTP"
        })
      }
    })

  }

  document.querySelectorAll(".otp-input").forEach((input, index, inputs) => {
  input.addEventListener("input", () => {
    if (input.value.length === 1 && index < inputs.length - 1) {
      inputs[index + 1].focus();
    }
  });

  input.addEventListener("keydown", (e) => {
    if (e.key === "Backspace" && input.value === "" && index > 0) {
      inputs[index - 1].focus();
    }
  });
});

</script>


</body>
</html>
