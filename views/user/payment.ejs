<%- include("../partials/user/header.ejs") %>
  <%- include("../partials/user/navbar.ejs") %>


    <div class="row pt-4 mt-5 mx-md-3">
      <div class="col-8 mt-5 px-4">
        <div class="bg-light p-5 border border-1 rounded-3 shadow-sm">
          <div class="container border p-3 mb-3 rounded shadow-sm address-card" style="height: 75px;"
            onclick="selectAddress(this)">
            <div class="d-flex justify-content-between align-items-start">

              <!-- Radio button (left) -->
              <div class="pt-1 pe-2">
                <input type="radio" name="address" value="COD" checked />
              </div>

              <!-- Address info (middle) -->
              <div class="flex-grow-1">
                <p class="mb-1 ms-1 fw-semibold">Cash On Delivery</p>
                <p class="text-muted small">Pay when your order arrives.</p>
              </div>

            </div>
          </div>
          <div class="container border p-2 mb-3 rounded shadow-sm address-card" style="height: 75px;"
            onclick="selectAddress(this)">
            <div class="d-flex justify-content-between align-items-start">

              <!-- Radio button (left) -->
              <div class="pt-1 pe-2">
                <input type="radio" name="address" value="UPI" />
              </div>

              <!-- Address info (middle) -->
              <div class="flex-grow-1 mt-1">
                <img src="https://developers.google.com/identity/images/g-logo.png" style="height: 20px;width: 20px;"
                  alt="">
                <small>Pay </small><small class="fw-bold">UPI Payment</small>
                <p class="ms-1 fw-normal small text-muted">Pay by any UPI app</p>
              </div>

            </div>
          </div>
          <div class="container border p-2 mb-3 rounded shadow-sm address-card" style="height: 75px;"
            onclick="selectAddress(this)">
            <div class="d-flex justify-content-between align-items-start">

              <!-- Radio button (left) -->
              <div class="pt-1 pe-2">
                <input type="radio" name="address" value="CARD" />
              </div>

              <!-- Address info (middle) -->
              <div class="flex-grow-1 mt-1">

                <small class="fw-bold">Credit/Debit/ATM Card</small>
                <p class="ms-1 fw-normal small text-muted">Add any secure card by RBI guidelines.</p>
              </div>

            </div>
          </div>
          <div class="container border p-2 mb-3 rounded shadow-sm address-card" style="height: 75px;"
            onclick="selectAddress(this)">
            <div class="d-flex justify-content-between align-items-start">

              <!-- Radio button (left) -->
              <div class="pt-1 pe-2">
                <input type="radio" name="address" value="WALLET" />
              </div>

              <!-- Address info (middle) -->
              <div class="flex-grow-1 mt-1">

                <small class="fw-bold">Wallet </small>
                <p class="ms-1 fw-normal small text-muted">Use your Fitbazar wallet</p>
              </div>

            </div>
          </div>
          <div class="container border p-2 mb-3 rounded shadow-sm address-card" style="height: 75px;"
            onclick="selectAddress(this)">
            <div class="d-flex justify-content-between align-items-start">

              <!-- Radio button (left) -->
              <div class="pt-1 pe-2">
                <input type="radio" name="address" value="RAZORPAY" />
              </div>

              <!-- Address info (middle) -->
              <div class="flex-grow-1 mt-1">
                <img src="/images/razorpay-1.png" style="height: 30px;width: 60px;" alt="">
                <small class="fw-bold">Razorpay</small>

              </div>

            </div>
          </div>
        </div>

      </div>
      <div class="col-4">


        <div class="p-3 shadow-sm border sticky-top rounded-3" style="background-color: rgb(212, 212, 212);top: 120px;">

          <div class="mb-1">
            <h5 class="fw-bold text-center">Order Summary</h5>
          </div>

          <div class="bg-light p-2 rounded-3">
            <!-- 1. Product Summary -->
            <% cartItems.forEach((item)=>{%>
              <div class="d-flex justify-content-between mb-2">
                <div><span class="fw-semibold">
                    <%= item.quantity %> × <%= item.productId.productName %>
                  </span></div>
                <div><span class="fw-semibold text-success">₹<%= item.productId.salePrice * item.quantity %></span>
                </div>
              </div>
              <% }) %>

                <!-- 2. Delivery Charges -->
                
                <div id="discountRow" class="d-flex justify-content-between small text-danger fw-semibold mb-2"
                  style="display: none;">
                  <div>Discount</div>
                  <div>-₹<span id="discountAmount">
                      <%= discount || 0 %>
                    </span></div>
                </div>
                <!-- 3. Platform Fee -->
                <div class="d-flex justify-content-between small fw-bold text-muted mb-3">
                  <div>Delivery Charge</div>
                  <div>₹<%= deliveryCharge %>
                  </div>
                </div>
          </div>
          <hr>

          <div
            class="bg-white d-flex align-items-center justify-content-center rounded w-25 mx-auto px-2 mb-2 shadow-sm text-center  border border-dark">
            <span class="fw-semibold" style="cursor: pointer;font-size: 13px;" id="showCoupons">COUPONS</span>
          </div>
          <!-- 4. Coupon Input -->
          <div class="d-flex input-group-sm mb-3 gap-2">
            <input type="text" id="couponCode" class="form-control ps-3" placeholder="Enter Coupon Code">
            <button class="btn btn-danger" id="applyCouponCode" type="button">Apply</button>
          </div>


          <hr>

          <!-- 5. Total Price -->
          <div class="d-flex justify-content-between mb-3 bg-light rounded-3 p-3">
            <div class="fw-bold">Total <br> <small class="text-muted fw-normal">In rupees</small></div>
            <div class="fw-bold text-success"><span id="totalAmount">₹<%= finalAmount %></span></div>
          </div>

          <!-- 6. Continue Button -->
          <button id="continueBtn" class="btn btn-dark w-100 fw-semibold">Continue</button>
        </div>

        <!-- 7.Coupon Modal -->>
        <div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-3 shadow">
              <div class="modal-header">
                <h5 class="modal-title" id="couponModalLabel">Available Coupons</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <% if (coupons.length> 0) { %>
                  <ul class="list-group" id="couponList">
                    <% coupons.forEach(function(coupon) { %>
                      <% if (finalAmount>= coupon.minimumPrice) { %>
                        <!-- ✅ Valid Coupon -->
                        <li class="list-group-item d-flex justify-content-between align-items-center coupon-item"
                          data-code="<%= coupon.name %>" style="cursor:pointer;">
                          <div>
                            <strong>
                              <%= coupon.name %>
                            </strong>
                            <small class="d-block text-muted">
                              Save ₹<%= coupon.offerPrice %> on orders above ₹<%= coupon.minimumPrice %>
                            </small>
                          </div>
                          <span class="badge bg-success rounded-pill">Apply</span>
                        </li>
                        <% } else { %>
                          <!-- ❌ Invalid Coupon (strike-through) -->
                          <li class="list-group-item d-flex justify-content-between align-items-center disabled">
                            <div>
                              <strong class="text-muted">
                                <%= coupon.name %>
                              </strong>
                              <small class="d-block text-muted">
                                Minimum order value of ₹<%= coupon.minimumPrice %> is required
                              </small>
                            </div>
                            <span class="badge bg-secondary rounded-pill">Not Eligible</span>
                          </li>
                          <% } %>
                            <% }) %>
                  </ul>
                  <% } else { %>
                    <p class="text-muted text-center mb-0">No coupons available at the moment.</p>
                    <% } %>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


    <%- include("../partials/user/footer.ejs") %>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

      <script>
        const type = "<%= typeof type !== 'undefined' ? type : '' %>";
        const productId = "<%= typeof productId !== 'undefined' ? productId : '' %>";
        const size = "<%= typeof size !== 'undefined'?size:'' %>"

        document.querySelectorAll(' .address-card input[type="radio" ]').forEach(radio => {
          radio.addEventListener('change', function () {
            // Reset all cards
            document.querySelectorAll('.address-card').forEach(card => {
              card.style.backgroundColor = "white";
            });

            // Highlight selected card
            const selectedCard = this.closest('.address-card');
            selectedCard.style.backgroundColor = "#f8f9fa";
          });
        });

        document.addEventListener("DOMContentLoaded", function () {

          const showCouponsBtn = document.getElementById("showCoupons");
          const couponInput = document.getElementById("couponCode");
          const couponItems = document.querySelectorAll(".coupon-item");

          showCouponsBtn.addEventListener("click", function () {
            const modal = new bootstrap.Modal(document.getElementById("couponModal"));
            modal.show();
          })

          couponItems.forEach(item => {
            item.addEventListener("click", () => {
              const code = item.getAttribute("data-code");
              couponInput.value = code;

              const modalEle = document.getElementById("couponModal");
              const modal = bootstrap.Modal.getInstance(modalEle);
              modal.hide();
            })
          })


        })

        document.getElementById("continueBtn").addEventListener("click", async function () {

          const selectedMethod = document.querySelector("input[name='address']:checked");

          if (!selectedMethod) {
            Swal.fire({
              icon: 'warning',
              title: 'Select address',
              text: "Please choose a payment method before submiting",
            })
            return;
          }

          try {

            const stockRes = await fetch("/cart/payment/check-stock");
            const stockData = await stockRes.json();

            if (!stockData.success) {
              Swal.fire({ icon: "error", title: "Error", text: stockData.message }).then(()=>window.location.reload());
              return
            }

            if (stockData.outOfStockItems.length > 0 || stockData.adjustedItems.length > 0) {
              await Swal.fire({
                icon: "warning",
                title: "Stock Update",
                html: stockData.message,
                confirmButtonText: "Proceed with updated cart"
              });
            }



            const res = await fetch("/cart/checkout/payment", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ paymentMethod: selectedMethod.value, type, productId,size })
            })

            const data = await res.json();

            if (data.success) {
              window.location.href = data.redirectUrl;
            }
            else {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message
              }).then(() => window.location.reload());
            }

          } catch (error) {
            console.error(error.message);
            Swal.fire({ icon: 'error', title: 'Error', text: "Something went wrong." });
          }


        })

        document.getElementById("applyCouponCode").addEventListener("click", async () => {
          const couponCode = document.getElementById("couponCode").value.trim();

          if (!couponCode) {
            Swal.fire({
              icon: "warning",
              title: "Please enter a coupon code"
            });
            return;
          }
          const urlParams = new URLSearchParams(window.location.search);
          const type = urlParams.get('type');
          const productId = urlParams.get("productId");

          let queryString = "";
          if (type && productId) {
            queryString = `?type=${encodeURIComponent(type)}&productId=${encodeURIComponent(productId)}`
          }

          try {

            const res = await fetch(`/cart/apply-coupon${queryString}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ couponCode })
            })

            const data = await res.json();

            if (data.success) {

              document.getElementById("discountRow").style.display = "flex";


              document.getElementById("discountAmount").innerHTML = data.discount;
              document.getElementById("totalAmount").innerHTML = data.finalAmount

              Swal.fire({
                icon: 'success',
                title: "Coupon Applied!",
                text: data.message || "Discount has been applied."
              }).then(() => {
                location.reload()
              })
            }
            else {
              Swal.fire({
                icon: "Error",
                title: "Invalid Coupon",
                text: data.message || "Please check the coupon code!"
              })
            }

          } catch (error) {
            console.log("Error", error.message);
          }



        })


      </script>

      </body>

      </html>